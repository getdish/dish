#!/bin/bash

set -eo pipefail

if [ "$FIRST_STEP" == "true" ]; then
  exit 0
fi

if [ "$DOCKER_TAG" == "true" ]; then
  docker tag \
    "gcr.io/dish-258800/$BUILDKITE_STEP_KEY/$BUILDKITE_PIPELINE_NAME-$BUILDKITE_STEP_KEY-build-$BUILDKITE_BUILD_ID" \
    "gcr.io/dish-258800/$BUILDKITE_STEP_KEY:latest"
fi

if [ "$LOG_DOCKER" == "true" ]; then
  echo "docker logs..."
  docker-compose logs --tail 2000
  cat ./*.logs || true
fi

if [ "$IS_COMPOSE_RUNNER" = "true" ] && [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ]; then
  echo "shutting down docker"
  docker-compose down --volumes || true
fi

if [ "$DOCKER_CLEAN" == "true" ] || { [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ] && [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ]; }; then
  docker system prune -a --filter "until=72h" --force || true
  docker system df | head -n 60 || true
  docker images -a | head -n 60 || true
fi

echo "bye"
