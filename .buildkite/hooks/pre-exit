#!/bin/bash

set -eo pipefail

if [ "$FIRST_STEP" == "true" ]; then
  exit 0
fi

if [ -n "$DOCKER_TAG" ]; then
  from="$BUILDKITE_PIPELINE_NAME-$BUILDKITE_STEP_KEY-build-$BUILDKITE_BUILD_NUMBER"
  to="registry.fly.io/$DOCKER_TAG"
  echo "docker tag $from $to"
  docker tag "$from" "$to"
  echo "docker tag $from $to:latest"
  docker tag "$from" "$to:latest"
  if [ -z "$DOCKER_SKIP_PUSH" ]; then
    echo "docker push $to"
    docker push "$to"
  fi
  #  > "$HOME/$DOCKER_TAG.push.log" & # do it in the background to be faster
  # if [ "$DOCKER_PUSH_SYNC" = "true" ]; then
    # wait
  # fi
fi

if [ "$BUILDKITE_COMMAND_EXIT_STATUS" -ne 0 ]; then
  touch exit_this_build
  echo "Steps are skipped because $BUILDKITE_AGENT_NAME:$BUILDKITE_LABEL returned $BUILDKITE_COMMAND_EXIT_STATUS" > exit_this_build
fi

if [ "$DOCKER_COMPOSE_DOWN" == "true" ]; then
  docker-compose down &
fi

if [ "$LOG_DOCKER" == "true" ]; then
  echo "docker logs..."
  docker-compose logs --tail 2000
  echo "other logs..."
  cat ./*.log || true
fi

if [ "$IS_COMPOSE_RUNNER" = "true" ] && [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ]; then
  echo "shutting down docker"
  docker-compose down --volumes || true
fi

if [ "$DOCKER_CLEAN" == "true" ] || { [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ] && [ "$DOCKER_CLEAN_ON_FAIL" = "1" ]; }; then
  ./dishctl.sh clean_docker_if_disk_full
fi

echo "bye"
