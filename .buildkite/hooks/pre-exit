#!/bin/bash

set -eo pipefail

if [ "$FIRST_STEP" == "true" ]; then
  exit 0
fi

if [ "$DISH_ENV" != "test" ]; then
  echo "not in test mode! danger"
  exit 1
fi

from="$BUILDKITE_PIPELINE_NAME-$BUILDKITE_STEP_KEY-build-$BUILDKITE_BUILD_NUMBER"
to="registry.dishapp.com/$DOCKER_TAG"

if [ -n "$DOCKER_TAG" ]; then
  echo "tagging, before:"
  docker images | grep "$from"
  echo "docker tag $from $to:latest"
  docker tag "$from" "$to:latest"
  echo "after:"
  docker images | grep "$to"
fi

if [ -n "$DOCKER_PUSH" ]; then
  echo "docker push $to:latest"
  docker push "$to:latest"
fi

if [ "$SHOW_DOCKER_IMAGES" = "true" ]; then
  docker images | head -n 30 || true
fi

if [ "$BUILDKITE_COMMAND_EXIT_STATUS" -ne 0 ]; then
  touch exit_this_build
  echo "Steps are skipped because $BUILDKITE_AGENT_NAME:$BUILDKITE_LABEL returned $BUILDKITE_COMMAND_EXIT_STATUS" > exit_this_build
fi

if [ "$DOCKER_COMPOSE_DOWN" == "true" ]; then
  docker-compose down &
fi

if [ "$LOG_DOCKER" == "true" ]; then
  echo "--- docker-compose logs"
  echo "Showing tail 100 lines (see all in $(pwd)/compose.log)..."
  echo "..."
  docker-compose logs | tail -n 100
  docker-compose logs --tail 6000 > ./compose.log
  # cat ./*.log || true
fi

if [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ] && [ "$DATA_CLEAR_ON_FAIL" == "true" ]; then
  echo "cleaning data on failure..."
  rm -rf "$POSTGRES_DB_DIR" || true
  rm -rf "$TIMESCALE_DB_DIR" || true
fi

if [ "$IS_COMPOSE_RUNNER" = "true" ] && [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ]; then
  echo "shutting down docker"
  docker-compose down || true
fi

if [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ] && [ "$DOCKER_CLEAN_ON_FAIL" = "1" ]; then
  rm -r "$POSTGRES_DB_DIR"
  rm -r "$TIMESCALE_DB_DIR"
fi

if [ "$DOCKER_CLEAN" == "true" ] || { [ "$BUILDKITE_COMMAND_EXIT_STATUS" = "1" ] && [ "$DOCKER_CLEAN_ON_FAIL" = "1" ]; }; then
  docker-compose down -t 4 || true
  CLEAN_BUILDKITE_BUILDS=true ./dsh clean_docker_if_disk_full
fi

echo "bye"
