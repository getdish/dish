import { join } from 'path'

import { User, WithID, userFindOne, userUpsert } from '@dish/graph'
import AppleSignIn, { AppleSignInOptions } from 'apple-sign-in-rest'
import { Request, Response } from 'express'
import jwt from 'jsonwebtoken'

import config from '../config/config'

// with this library https://github.com/renarsvilnis/apple-sign-in-rest
// at end of implementation i found this library, slightly more maintained:
// may want to switch if we get issues:
// https://github.com/A-Tokyo/apple-signin-auth

const redirectUri = 'https://auth.dishapp.com/auth/apple_authorize'
const appleConfig: AppleSignInOptions = {
  clientId: 'com.dishapp',
  teamId: '399WY8X9HY', // or dish.motion ?
  keyIdentifier: 'M5CPALWBA5',
  privateKeyPath: join(__dirname, '../../AuthKey_M5CPALWBA5.p8'),
}

const appleSignIn = new AppleSignIn(appleConfig)

class AppleAuthController {
  static getAuthUrl = async (req: Request, res: Response) => {
    const authorizationUrl = appleSignIn.getAuthorizationUrl({
      // @ts-ignore
      scope: ['name', 'email'],
      redirectUrl: 'http://localhost:3000/auth/apple/callback',
      // (Optional) Value of the anti-forgery unique session token, as well as any other information needed to recover the context when the user returns to your application, e.g., the starting URL.
      state: '123',
      // (Optional) A random value generated by your app that enables replay protection when present.
      nonce: 'insert-generated-uuid',
    })
  }

  // should be called no more than once a day
  static refreshToken = async (req: Request, res: Response) => {
    // const { user_id } = req.body
    // const user = await userFindOne({ id: user_id })
    // const refreshTokenResponse = await appleSignIn.refreshAuthorizationToken(clientSecret, refreshToken);
    // const { access_token } = refreshTokenResponse.access_token;
    // TODO store access_token on user
  }

  static authCallback = async (req: Request, res: Response) => {
    let { user: reqUser, id_token, code, state, error } = req.body
    console.log('sign in response', JSON.stringify(req.body, null, 2))

    const clientSecret = appleSignIn.createClientSecret({
      // expirationDuration: 5 * 60, // 5 minutes
    })

    const tokenResponse = await appleSignIn.getAuthorizationToken(
      clientSecret,
      code,
      {
        // Optional, use the same value which you passed to authorisation URL. In case of iOS you skip the value
        redirectUri,
      }
    )

    const claim = await appleSignIn.verifyIdToken(tokenResponse.id_token, {
      ignoreExpiration: true, // default is false
    })

    // TODO STORE INFO ON USER
    const apple_uid = claim.aud
    const apple_secret = clientSecret
    const apple_refresh_token = tokenResponse.refresh_token

    console.log('got', {
      apple_uid,
      apple_secret,
      apple_refresh_token,
      tokenResponse: tokenResponse.id_token,
    })

    // user is passed on first signup
    let user: WithID<User> | null = null
    try {
      if (apple_uid) {
        user = await userFindOne({
          apple_uid,
        })
      } else {
        user = await userFindOne({
          apple_email: reqUser.email,
        })
      }
    } catch (error) {
      console.error('user find error', error)
      return res.status(401).send()
    }

    if (!user) {
      try {
        // first time, create user
        user = await userUpsert([
          {
            username: `${reqUser.name.firstName} ${reqUser.name.lastName}`,
            password: reqUser.code,
            email: reqUser.email,
            role: 'user',
          },
        ])[0]
      } catch (error) {
        console.error('user create error', error)
        return res.status(401).send()
      }
    }

    // add apple info
    try {
      const finalUser = await userUpsert([
        {
          ...user,
          apple_secret,
          apple_uid,
          apple_refresh_token,
        },
      ])
      if (finalUser[0]) {
        user = finalUser[0]
      }
    } catch (err) {
      console.error('final user update error', error)
      return res.status(401).send()
    }

    if (!user) {
      console.error('no user?')
      return res.status(401).send()
    }

    const token = jwt.sign(
      {
        username: user.username,
        userId: user.id,
        'https://hasura.io/jwt/claims': {
          'x-hasura-user-id': user.id,
          'x-hasura-allowed-roles': [user.role],
          'x-hasura-default-role': user.role,
        },
      },
      config.jwtSecret,
      { expiresIn: '1w' }
    )

    console.log('token', token)

    return res.redirect(
      `https://dishapp.com/onboard?user=${encodeURIComponent(
        user.username!
      )}&token=${encodeURIComponent(token)}`
    )
  }
}

export default AppleAuthController
