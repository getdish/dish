- args:
    cascade: false
    read_only: false
    sql: "CREATE EXTENSION IF NOT EXISTS \"unaccent\";\r\n\r\nCREATE OR REPLACE FUNCTION
      slugify(\"value\" TEXT)\r\nRETURNS TEXT AS $$\r\n  -- removes accents (diacritic
      signs) from a given string --\r\n  WITH \"unaccented\" AS (\r\n    SELECT unaccent(\"value\")
      AS \"value\"\r\n  ),\r\n  -- lowercases the string\r\n  \"lowercase\" AS (\r\n
      \   SELECT lower(\"value\") AS \"value\"\r\n    FROM \"unaccented\"\r\n  ),\r\n
      \ -- remove single and double quotes\r\n  \"removed_quotes\" AS (\r\n    SELECT
      regexp_replace(\"value\", '[''\"]+', '', 'gi') AS \"value\"\r\n    FROM \"lowercase\"\r\n
      \ ),\r\n  -- replaces anything that's not a letter, number, hyphen('-'), or
      underscore('_') with a hyphen('-')\r\n  \"hyphenated\" AS (\r\n    SELECT regexp_replace(\"value\",
      '[^a-z0-9\\\\-_]+', '-', 'gi') AS \"value\"\r\n    FROM \"removed_quotes\"\r\n
      \ ),\r\n  -- trims hyphens('-') if they exist on the head or tail of the string\r\n
      \ \"trimmed\" AS (\r\n    SELECT regexp_replace(regexp_replace(\"value\", '\\-+$',
      ''), '^\\-', '') AS \"value\"\r\n    FROM \"hyphenated\"\r\n  )\r\n  SELECT
      \"value\" FROM \"trimmed\";\r\n$$ LANGUAGE SQL STRICT IMMUTABLE;\r\n\r\n\r\nCREATE
      FUNCTION public.set_slug_from_title() RETURNS trigger\r\n    LANGUAGE plpgsql\r\n
      \   AS $$\r\nBEGIN\r\n  IF EXISTS (SELECT FROM restaurant WHERE slug = slugify(NEW.name))
      THEN\r\n    IF EXISTS (SELECT FROM restaurant WHERE slug = slugify(NEW.name
      || '-' || NEW.city)) THEN\r\n      NEW.slug := slugify(NEW.name || '-' || NEW.city
      || '-' || NEW.address);\r\n    ELSE\r\n      NEW.slug := slugify(NEW.name ||
      '-' || NEW.city);\r\n    END IF;\r\n  ELSE\r\n    NEW.slug := slugify(NEW.name);\r\n
      \ END IF;\r\n  RETURN NEW;\r\nEND\r\n$$;\r\n\r\nCREATE TRIGGER \"t_restaurant_insert\"
      BEFORE INSERT ON \"restaurant\" FOR EACH ROW WHEN (NEW.name IS NOT NULL AND
      NEW.slug IS NULL)\r\nEXECUTE PROCEDURE set_slug_from_title();"
  type: run_sql
