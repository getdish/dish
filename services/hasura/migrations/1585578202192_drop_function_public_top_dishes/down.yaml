- args:
    cascade: false
    read_only: false
    sql: |-
      CREATE OR REPLACE FUNCTION public.top_dishes(lon numeric, lat numeric, radius numeric)
       RETURNS SETOF top_dishes_results
       LANGUAGE sql
       STABLE
      AS $function$
        SELECT
          (SELECT DISTINCT tags) AS dish,
          COUNT(tags) AS frequency
          FROM (
            SELECT t.name
              FROM restaurant
              INNER JOIN restaurant_taxonomy rt ON restaurant.id = rt.restaurant_id
              INNER JOIN taxonomy t ON rt.taxonomy_id = t.id
              AND
                ST_DWithin(restaurant.location, ST_SetSRID(ST_MakePoint(lon, lat), 0), radius)
          ) AS dt(tags)
          GROUP BY tags ORDER BY frequency DESC limit 50
      $function$;
  type: run_sql
