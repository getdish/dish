#!/bin/bash

shift 1

set -e

if [[ $NO_CHECK == true ]]; then
  echo "skip typecheck"
else
  if [ -f tsconfig.tsbuildinfo ]; then rm tsconfig.tsbuildinfo; fi
  if [ -d _ ]; then rm -r _; fi
  if [ -d dist ]; then rm -r dist; fi
  # first build types fast
  yarn tsc --emitDeclarationOnly --skipLibCheck --skipDefaultLibCheck
  # then copy to dist as well to only build once
  cp -r _ dist
fi

if [ $SWC ]; then
  DIR=$(dirname $(realpath $0))
  swc src -s -c $DIR/.swcrc-modern --out-dir _ &
  swc src -s -c $DIR/.swcrc-node --out-dir dist &
else
  FILES=$(find ./src \( -name '*.ts' -o -name '*.tsx' \))
  esbuild $FILES --sourcemap --outdir=_  --target=safari13 "$@" &
  esbuild $FILES --sourcemap --outdir=dist --format=cjs --target=node12.19.0 "$@" &
fi

wait
