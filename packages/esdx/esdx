#!/bin/bash

shift 1

if [[ $NO_CHECK == true ]]; then
  echo "skip typecheck"
else
  # first build types fast
  tsc --emitDeclarationOnly --skipLibCheck --skipDefaultLibCheck
  # then copy to dist as well to only build once
  rm -r dist || true
cp -r _ dist
fi

if [ $SWC ]; then
  DIR=$(dirname $(realpath $0))
  swc src -s -c $DIR/.swcrc-modern --out-dir _ &
  swc src -s -c $DIR/.swcrc-node --out-dir dist &
else
  FILES=$(find ./src \( -name '*.ts' -o -name '*.tsx' \))
  esbuild $FILES --sourcemap --outdir=_  --target=safari13 "$@" &
  esbuild $FILES --sourcemap --outdir=dist --format=cjs --target=node12.19.0 "$@" &
fi

wait
